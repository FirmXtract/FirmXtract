name: DumprX Using Crave
 
on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: "Direct Link of the ROM/Firmware to Dump"
        required: true
      EXTRA_CMD:
        description: "Any Extra Command to Run Before Dump"
        required: false

defaults:
  run:
    shell: bash

env:
  # ROM
  ROM_URL: ${{ github.event.inputs.ROM_URL }}

  # Gitlab
  PUSH_TO_GITLAB: true

  # Extra Command
  EXTRA_CMD: ${{ github.event.inputs.EXTRA_CMD }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Check-out in order to access the repository's files.
      - name: Check-out to repository
        uses: actions/checkout@v4

      # Set-up a spearate directory for the device.
      - name: Set-up workspace environment
        run: |
          mkdir workspace
          cd workspace
        continue-on-error: true      
      - name: Configure the 'crave' environment
        run: |
            if [ "${DCDEVSPACE}" == "1" ]; then
              echo 'No need to set up crave, we are already running in devspace!'
            else
              curl -s https://raw.githubusercontent.com/accupara/crave/master/get_crave.sh | bash -s --
              mkdir ${HOME}/bin/
              mv ${PWD}/crave ${HOME}/bin/
              sudo ln -sf /home/${USER}/bin/crave /usr/bin/crave
              mkdir ~/.ssh
            fi
      - name: Configure Crave Credentials
        run: | 
              envsubst < ${PWD}/crave.conf.sample >> ${PWD}/crave.conf
              rm -rf ${PWD}/crave.conf.sample
        env:
             CRAVE_USERNAME: ${{  secrets.CRAVE_USERNAME  }}
             CRAVE_TOKEN: ${{  secrets.CRAVE_TOKEN  }}                        
      - name: Extract using Crave
        run: |
              crave -c crave.conf devspace -- "rm -rf DumprX; 
              git clone https://github.com/DumprX/DumprX.git DumprX;
              cd DumprX; \
              rm -rf  .github_token .github_orgname .gitlab_token .gitlab_group ~/.ssh/id_rsa  .tg_token .tg_chat; \
              echo '${{ secrets.GITLAB_TOKEN }}' > .gitlab_token  # Only for Gitlab; \
              echo '${{ secrets.GITLAB_GROUP }}' > .gitlab_group  # Only for Gitlab; \
              echo '${{ secrets.PRIV_SSH_KEY }}' > ~/.ssh/id_rsa  # Only for Gitlab; \
              echo '${{ secrets.BOT_TOKEN }}' > .tg_token;\ 
              echo '${{ secrets.CHAT_ID }}' > .tg_chat; \
              chmod 600 ~/.ssh/id_rsa;\
              crave push --projectID 77 .github_token .github_orgname .gitlab_token .gitlab_group ~/.ssh/id_rsa  .tg_token .tg_chat;  \
              crave run --projectID 77 -- "sudo bash setup.sh; \
              sudo apt install -y f2fs-tools; \
              git config --global user.name "${{ github.actor }}"; \
              git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"; \
              chmod 600 ~/.ssh/id_rsa; \
              $EXTRA_CMD; \
              ./dumper.sh '${{ github.event.inputs.ROM_URL }}'""
      # Only reach this when the user killed the workflow.
      - name: Execute if the job is cancelled
        if: ${{ cancelled() }}
        run: cd DumprX; crave stop --projectID 77 --all